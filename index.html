<!doctype html>
<meta charset=utf-8>
<meta name=viewport content="width=device-width">
<title>phosphorus++</title>
<link rel=stylesheet href=player.css>
<link rel=stylesheet href=index.css>
<link rel=stylesheet href=touch.css>
<span style="font-family: 'Scratch#1font-family', Scratch;"></span>
<div class=area id=title-area>
<h1 class=title>phosphorus++</h1> 
<p>phosphorus runs your Scratch projects really fast by compiling them to JavaScript. Try it out by pasting a URL or project ID into the field below or <a class=dropdown>choosing an example<select id=examples>
  <option value>
  <option value=102592962>Maniac Miner by Dogtopius
  <option value=102572692>CRATE platformer by n-gauge
  <option value=22734605>Apollos by fezzinate
  <option value=56667792>FNAF2 by ???
  <option value=74096796>Burger Kong by jetpac
  <option value=74221074>Flight Sim by WO997
  <option value=11397100>3D Remix by DadOfMrLog
  <option value=109591705>3D X-Wing by Sir Cool
  <option value=55416430>Shovel Knight by JamesOuO
  <option value=120395395>Snake AI by Harrytheawesome
  <option value=56667360>Hill Climber by griffpatch
  <option value=15945630>O by DCPU-16
  <option value=10128407>Paper Minecraft by griffpatch
  <option value=16207935>Alone in the depths by sticku
  <option value=16205373>3D Framework by DadOfMrLog
  <option value=31903442>gb.sb2 [Dr. Mario] by DCPU-16
  <option value=34791164>gb.sb2 [Mario Land 2] by DCPU-16
  <option value=21554369>Epic Ninja by griffpatch
  <option value=15832807>Pretty by blob8108
  <option value=54931060>Super Hexagon Demo by novice27b
  <option value=124823106>Portal by Ham5andw1ch
  <option value=125838211>Pokemon 2 player battle by EmperorTang
  <option value=129219672>If Touching Color by StartScratchApp
  <option value=128088769>Advanced Maze Gen. by AiyanMind
  <option value=132863287>Gravity Blocks by jay
  <option value=130008325>Effects testing by n-gauge
  <option value=19204741>HACKED ASCII KEYPRESS by griffpatch
  <option value=88564231>HACKED ASCII WORDPRO. by griffpatch
</select></a>. </p>
</div>

<div class=area id=player-area>
<div class=controls>
  <span class=stop></span>
  <span class=pause></span>
  <span class=flag title="Shift+click to enable turbo mode."></span>
  <div class=turbo>Turbo Mode</div>
  <span class=full-screen></span>
</div>
<div class=player></div>
<div class=internal-error>
  An internal error occurred. <a id=error-bug-link target=_blank href=https://github.com/nathan/phosphorus/issues/new>Click here</a> to file a bug report.
</div>
</div>

<div class=title>
  <div class=progress-bar></div>
  <input class=url value=https://scratch.mit.edu/projects/>
  <a target=_blank class=project-link title="View project on Scratch"></a>
</div>

<div id="touchscreen">
  <div>
    <img id="touch_up" src="images/up_arrow.png" oncontextmenu="return false;" ontouchstart="checkGamepad('up')" ontouchend="checkGamepad('up_cancel')">
  </div>

<img id="touch_left" src="images/left_arrow.png" oncontextmenu="return false;" ontouchstart="checkGamepad('left')" ontouchend="checkGamepad('left_cancel')">
<img id="touch_right" src="images/right_arrow.png" oncontextmenu="return false;" ontouchstart="checkGamepad('right')" ontouchend="checkGamepad('right_cancel')">

<img id="touch_B" src="images/b_button.png" oncontextmenu="return false;" ontouchstart="checkGamepad('b')" ontouchend="checkGamepad('none')">

  <div>
    <img id="touch_down" src="images/down_arrow.png" oncontextmenu="return false;" ontouchstart="checkGamepad('down')" ontouchend="checkGamepad('down_cancel')">
    <img id="touch_A" src="images/a_button.png" oncontextmenu="return false;" ontouchstart="checkGamepad('a')" ontouchend="checkGamepad('none')">
  </div>
</div>

<div class=area id=project-area>
<section class=package>
  <h1>Package this project</h1>
  <p>Get a link to a web page that automatically runs your project.</p>
  <p>
    <a href=# target=_blank id=package-link>Package</a>
    <input type=checkbox id=package-turbo>
    <label for=package-turbo>Turbo mode</label>
    <input type=checkbox id=package-full-screen checked>
    <label for=package-full-screen>Full screen</label>
    <input type=checkbox id=package-apk>
    <span style="border:1px dashed #cecece">	  
      <label for=package-apk>Android apk</label>
    </span>
  </p>
</section>
<section class=package>
  <h1>Embed this project</h1>
  <p>Include the phosphorus player in your web site.</p>
  <p>
    <input readonly id=embed-code>
    <input type=checkbox id=embed-auto-start checked>
    <label for=embed-auto-start>Start automatically</label>
    <input type=checkbox id=embed-light-content>
    <label for=embed-light-content>Light controls</label>
    <input type=checkbox id=embed-hide-controls>
    <label for=embed-hide-controls>Hide UI</label>
  </p>
</section>
<section>
  <h1>Report a problem</h1>
  <p>phosphorus is still in development. <a id=bug-link target=_blank href=https://github.com/nathan/phosphorus/issues/new>Click here</a> to report a problem with this project.</p>
</section>
</div>
<section>
  <h1>Credits</h1>
  <p>phosphorus was created by <a href='https://github.com/nathan'>Nathan Dinsmore</a>. Its CPS-style compilation and overall design was inspired by <a href='https://github.com/RHY3756547'>Rhys Simpson</a>'s <a href='https://code.google.com/p/sb2-js/'>sb2.js</a>. It would have more bugs if not for <a href='https://github.com/MathWizz'>Truman Kilen</a>. It uses the <a href='http://stuk.github.io/jszip/'>JSZip</a> library, created by <a href='https://github.com/stuk'>Stuart Knightley</a>, <a href='https://github.com/dduponchel'>David Duponchel</a>, Franz Buchinger, and <a href='https://github.com/aadsm'>Ant√≥nio Afonso</a>, to read <code>.sb2</code> files and compressed projects, and the <a href='https://code.google.com/p/canvg/'>canvg</a> library, created by <a href='https://code.google.com/u/gabelerner@gmail.com/'>Gabe Lerner</a>, to render SVGs in <code>&lt;canvas&gt;</code> elements. <a href='http://goo.gl/zI6A'>HTML Games</a> added sound (via javascript wav conversion), various fixes and touch controls for tablets and mobile. Coming soon - compile your project to an APK via webview (as shown on the <a href='http://goo.gl/zI6A'>HTML5 Game to Android App</a> Link)
  <h1>Code</h1>
  <p>The source code for phosphorus is available <a href=https://github.com/nathan/phosphorus>on GitHub</a>. <a href='#' title='Download this fork...'>[Zip]</a></p>
</section>
<script src='fonts.js'></script>
<script src='jszip.js'></script>
<script src='rgbcolor.js'></script>
<script src='StackBlur.js'></script>
<script src='canvg.js'></script>
<script src='autoload.js'></script>
<script src='phosphorus.js'></script>
<script src='player.js'></script>

<script src='apk.js'></script>
<script>
	
(function() {
  'use strict'; 

  if (location.protocol === 'https:') {
    //location.replace(('' + location).replace(/^https:/, 'http:')); // pf: we run on https now
  }

  var prefix = 'https://scratch.mit.edu/projects/';

  var initialId = location.hash.substr(1);
  if (initialId === 'zip') initialId = '';

  var titleArea = document.querySelector('#title-area');
  var playerArea = document.querySelector('#player-area');
  var projectArea = document.querySelector('#project-area');

  playerArea.style.height = projectArea.style.height = 'auto';
  var titleAreaHeight = titleArea.offsetHeight;
  var playerAreaHeight = playerArea.offsetHeight;
  var projectAreaHeight = projectArea.offsetHeight;
  playerArea.style.height = projectArea.style.height = 0;

  var examples = document.querySelector('#examples');
  var urlInput = document.querySelector('.url');
  urlInput.value = prefix + initialId;

  var progressBar = document.querySelector('.progress-bar');
  var player = document.querySelector('.player');
  var projectLink = document.querySelector('.project-link');
  var bugLink = document.querySelector('#bug-link');

  var packageLink = document.querySelector('#package-link');
  var packageTurbo = document.querySelector('#package-turbo');
  var packageFullScreen = document.querySelector('#package-full-screen');
  var packageApk = document.querySelector('#package-apk');

  var embedCode = document.querySelector('#embed-code');
  var embedAutoStart = document.querySelector('#embed-auto-start');
  var embedLightContent = document.querySelector('#embed-light-content');
  var embedHideControls = document.querySelector('#embed-hide-controls');

  var timeout;

  if (!!window.location.search.match("turbo=true")) packageTurbo.checked = true;
	
  urlInput.addEventListener('input', function() {
    var ss = urlInput.selectionStart;
    var se = urlInput.selectionEnd;
    var url = urlInput.value;
    var id = url.match(/\d+/g) || [''];
    while (id.length > 1 && id.indexOf(P.player.projectId) > -1) {
      id.splice(id.indexOf(P.player.projectId), 1);
    }
    id = id[0];
    urlInput.value = url = prefix + id;
    urlInput.selectionStart = urlInput.selectionEnd = Math.max(prefix.length, ss);
    clearTimeout(timeout);
    if (P.player.projectId !== id) {
      timeout = setTimeout(function() {
        location.hash = '#' + id;
      }, 300);
    }
  });
  urlInput.addEventListener('focus', function() {
    setTimeout(function() {
      if (/\d/.test(urlInput.value)) {
        urlInput.select();
      }
    });
  });

  examples.addEventListener('change', function() {
    if (examples.value && !location.hash.length) { // pf
      TurboMode = true; // hardcoded (see comment in js) !!window.location.search.match("turbo=true"); // reset
      console.log("turbo=" + TurboMode + "#" + examples.value);
      location.hash = '#' + examples.value;
      examples.selectedIndex = 0;
    }
  });

  window.addEventListener('hashchange', function() {
    var id = location.hash.substr(1);
    if (id !== 'zip') {
      if (+id !== +id) id = '';
      urlInput.value = prefix + id;
    }
    load(id);
  });

  function show(id) {
    titleArea.style.height = id ? 0 : titleAreaHeight + 'px';
    playerArea.style.height = id ? playerAreaHeight + 'px' : 0
    projectArea.style.height = id ? projectAreaHeight + 'px' : 0;
    if (!id) urlInput.focus();
  }

  function load(id) {
    if (id !== 'zip') {
      show(id);
    } else {
      id = '';
    }

    document.title = 'phosphorus++';
    P.player.load(id, function(stage) {
      stage.triggerGreenFlag();
    }, function(title) {
      document.title = title ? title + ' \xb7 phosphorus++' : 'phosphorus++';
      updateBugLink();
      // PF auto define touch keys B,A if the projects title contains use keys B and A
      if (title.match("use keys ")) {
	 var Bkey = title.split("use keys ")[1].split(" and ")[0];
	 var Akey = title.split("use keys ")[1].split(" and ")[1];
	 // assume is valid scratch key
	 document.getElementById("touch_B").value = Bkey.toUpperCase().charCodeAt(0);
	 document.getElementById("touch_A").value = Akey.toUpperCase().charCodeAt(0);
	 // then check B 1st for hacked / extended types
	 if (Bkey.match("space") || Bkey.match("ctrl") || Bkey.match("enter")) {
	    if (Bkey.match("space")) document.getElementById("touch_B").value = 32;
	    if (Bkey.match("ctrl")) document.getElementById("touch_B").value = 17;
	    if (Bkey.match("enter")) document.getElementById("touch_B").value = 13;
	 }
	 // then A for hacked / extended types
	 if (Akey.match("space") || Akey.match("ctrl") || Akey.match("enter")) {
	    if (Akey.match("space")) document.getElementById("touch_A").value = 32;
	    if (Akey.match("ctrl")) document.getElementById("touch_A").value = 17;
	    if (Akey.match("enter")) document.getElementById("touch_A").value = 13;
	 }
	 console.log(document.getElementById("touch_B").value + ":" + document.getElementById("touch_A").value);
      }
    });

    projectLink.href = P.player.projectURL;
    updateBugLink();
    updatePackageLink();
    updateEmbedCode();
  }

  function updateBugLink() {
    bugLink.href = P.player.projectId ? 'https://github.com/nathan/phosphorus/issues/new?title=' + encodeURIComponent(P.player.projectTitle || P.player.projectURL) + '&body=' + encodeURIComponent('\n\n\n' + P.player.projectURL + '\nhttp://phosphorus.github.io/#' + P.player.projectId + '\n' + navigator.userAgent) : 'https://github.com/nathan/phosphorus/issues/new?body=' + encodeURIComponent('\n\n\n' + navigator.userAgent);
  }

  function updatePackageApk() {
    if (packageApk.checked) {
      sb2apk(true); // generate full apk :)
    }
  }

  function updatePackageLink() {
    // pf: mod - if we have dropped an sb2 file and click package it will generate autoload.js instead...
    var packageLinkhref = P.player.projectId ? window.location.href.split("/index.html")[0] + '/app.html?id=' + P.player.projectId + '&turbo=' + packageTurbo.checked + '&full-screen=' + packageFullScreen.checked : 'about:blank';
    packageLink.href = "javascript:if (location.hash.substr(1) === 'zip') {sb2apk(false);} else {window.location.href = '" + packageLinkhref + "'}"; // generate autoload.js instead  
  }
  
  packageApk.addEventListener('change', updatePackageApk);
  packageTurbo.addEventListener('change', updatePackageLink);
  packageFullScreen.addEventListener('change', updatePackageLink);

  function updateEmbedCode(e) {
    embedCode.value = P.player.projectId ? '<script src=' + window.location.href.split("/index.html")[0] + '/embed.js?id=' + P.player.projectId + (embedHideControls.checked ? '&ui=false' : '&auto-start=' + embedAutoStart.checked + '&light-content=' + embedLightContent.checked + '&turbo=' + packageTurbo.checked) + '></' + 'script>' : ''; // was  + location.host
    embedAutoStart.disabled =
    embedLightContent.disabled = embedHideControls.checked;
    if (embedHideControls.checked) embedAutoStart.checked = true;
    if (e) embedCode.focus();
  }

  function selectEmbedCode() {
    setTimeout(function() {
      embedCode.select();
    });
  }

  embedCode.addEventListener('focus', selectEmbedCode);
  embedCode.addEventListener('click', selectEmbedCode);
  embedHideControls.addEventListener('change', updateEmbedCode);
  embedAutoStart.addEventListener('change', updateEmbedCode);
  embedLightContent.addEventListener('change', updateEmbedCode);

  load(initialId);

  setTimeout(function() {
    function setTransition(el) {
      el.style.WebkitTransition =
      el.style.MozTransition =
      el.style.OTransition =
      el.style.transition = 'height 0.2s';
    }
    setTransition(titleArea);
    setTransition(playerArea);
    setTransition(projectArea);
  });

  function cancel(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
  }
  document.body.addEventListener('dragover', cancel);
  document.body.addEventListener('dragenter', cancel);

  document.body.addEventListener('drop', function(e) {
    e.preventDefault();
    var f = e.dataTransfer.files[0];
    if (f) {
      // if you drop a sb2 file onto the index page, the console.log will generate a base64 var for you to use in autoload.js
      // This allows you to play the scratch project offline, or create an APK using a webview or ebook... let the fun begin!
      console.log('Creating autoload.js data... Please be patient...\n\n');
      var reader = new window.FileReader();
      reader.readAsDataURL(f); 
      reader.onloadend = function() {
        apkData64 = reader.result.replace("data:;base64,","");                
        console.log('var sb2Data64 = "' + apkData64 + '";\n\n');
      }
      location.hash = '#zip';
      show('zip');
      var ext = f.name.split('.').pop();
      if (ext === 'sb2' || ext === 'zip') {
        var request = P.IO.loadSB2File(f);
      } else if (ext === 'json') {
        request = P.IO.loadJSONFile(f);
      }
      if (request) {
        P.player.showProgress(request, function(stage) {
          stage.triggerGreenFlag();
        });
      }
    }
  });

  function b64toBlob(sb2Data64) { // pf :)

    var byteCharacters = atob(sb2Data64);
    var byteArrays = [];
    var sliceSize = 512;

    for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
      var slice = byteCharacters.slice(offset, offset + sliceSize);

      var byteNumbers = new Array(slice.length);
      for (var i = 0; i < slice.length; i++) {
        byteNumbers[i] = slice.charCodeAt(i);
      }

      var byteArray = new Uint8Array(byteNumbers);

      byteArrays.push(byteArray);
    }
    
    var blob = new Blob(byteArrays, {type: 'application/sb2'});
    return blob;
  }

  // pf here we autoload a project if exists as a base64 var...
  var o_id = window.location.hash.substr(1) + "e0";
  if (typeof sb2Data64 != "undefined" && isNaN(o_id)) { // pf f -  
    //e.preventDefault();
    location.hash = '#zip';
    show('zip');
    var blob = b64toBlob(sb2Data64);
    var request = P.IO.loadSB2File(blob); 
    if (request) {
      console.log("Local project detected");
      P.player.showProgress(request, function(stage) {
        stage.triggerGreenFlag();
      });
    }
  } else {console.log("Ready!");}

  // PF TODO:improve touch controls...
  //document.body.addEventListener('touchmove',function(event){event.preventDefault();});
  //document.body.addEventListener('touchstart',function(event){event.preventDefault();});
  //setTimeout(function(){window.scrollTo(0, 1);}, 1);	
	
}());

function sb2apk(bFull) {
  // PF: helper functions for apk creation (for Chrome and Android Webview only)
    var zip = new JSZip();
    bFull = bFull || 0;
    if (bFull) {
      console.log("Generating Apk...");
      if (typeof apkBase64 == 'undefined' || apkBase64.length == 0) return console.log("NOT FOUND: apk 'skeleton' webview container. PROCESS ABORTED!");
      if (typeof apkData64 == 'undefined' || apkData64.length == 0) return console.log("NOT FOUND: apk autoload data; drop sb2 file. PROCESS ABORTED!");
      zip.load(apkBase64, {base64: true}); // apk 'skeleton' webview container
      zip.file("autoload.js", apkData64); // overwrite this file in zip with our one!
      var base64 = zip.generate({type:"base64"}); // was blob
      var apk = document.createElement("a");
      apk.href ="data:application/zip;base64," + base64;
      apk.download = "sb2.apk"; // for now...
      apk.textContent = "";
      document.body.appendChild(apk); // using a link
      apk.click();
    } else {
      console.log("Generating autoloader..."); // for offline use too! 
      if (typeof apkData64 == 'undefined' || apkData64.length == 0) return console.log("NOT FOUND: apk autoload data; drop sb2 file. PROCESS ABORTED!");
      var ajs = document.createElement("a");
      ajs.href = 'data:text/html;charset=utf-8,' + 'var sb2Data64 = "' + apkData64 + '";';
      ajs.download = "autoload.js"; // for now...
      ajs.textContent = "";
      document.body.appendChild(ajs); // using a link
      ajs.click();	  
    }
    console.log("Done!");
}

</script>
